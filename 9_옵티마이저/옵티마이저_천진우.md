# 9 옵티마이저

### 9.1.2 옵티마이저의 종류

Q. 규칙기반 최적화와 비용 기반 최적화의 차이와 현재 어떤 것을 더 많이 사용하는지

비용 기반 최적화는 레코드 수나 선택도 고려. 비용 기반 최적화가 더 많이 사용

### 9.2.1 풀 테이블 스캔과 인덱스 스캔

Q. 리드어헤드란 무엇일까요?

연속된 데이터가 일정 수 이상 읽히면, 어떤 영역의 데이터가 앞으로 필요해질거다는 것을 예측해서, 요청이 들어오기 전에 미리 InnoDB 버퍼 풀에 적재 → 그래서 풀테이블 스캔에서 페이지를 하나씩 가져오는 것은 아니더라.

Q. 리드어헤드는 풀테이블 스캔에서만 사용된다. (Y/N)

No. 조건 없이 count() 쿼리를 쓰면 풀 인덱스 스캔에서도 리드어헤드를 적용한다.

### 9.2.2 병렬 처리

Q. 하나의 쿼리를 여러 스레드가 병렬처리 하는 조건은?

아무 조건없이 단순 테이블의 전체 건수를 가져오는 쿼리만 가능

### 9.2.3  ORDER BY 처리 - filesort

Q. 정렬해야할 데이터가 소트 버퍼보다 크다면 어떻게 정렬할까?

버퍼에 담을 수 있는 크기로 레코드들을 여러 조각으로 나눠서 정렬하고, 병합하면서 정렬을 수행

Q. 소트 버퍼는 세션 메모리일까 공유메모리일까?

세션메모리. 여러 커넥션에서 대량의 소트 버퍼를 사용하면, 운영체제 메모리 부족 현상이 일어날 수 있음.

소트 버퍼를 너무 크게 설정하면, mysql 서버가 죽을 수 있음. 대량의 데이터 정렬이 필요하면, 해당 세션의 소트 버퍼만 일시적으로 늘려서 쿼리를 실행하고 줄이는 방법도 좋다.

Q.  싱글 패스 정렬 방식 VS 투 패스 정렬 방식 차이

싱글 패스 정렬 방식: SELECT 대상이 되는 컬럼 전부를 담아서 정렬 실행

투 패스 정렬 방식: 정렬에 필요한 값과 PK만 넘겨서 정렬.

extra) Q. 일반적으로 싱글 패스를 사용하는데, 어떤 경우에 투패스 정렬을 사용할까요?

- 레코드 크기가 시스템 변수에 설정된 값보다 클 때
- BLOB 이나 TEXT 타입일 때

extra) SELCT 쿼리에서 모든 컬럼을 가져오는 경우에, 정렬 버퍼를 몇~몇십배를 비효율적으로 사용할 수 있음.

→ ORM 쓸 때 정렬같은게 들어가면 엔티티로 가져오지 말아야겠다..

Q. 인덱스 정렬을 위한 조건?

- order by에 명시된 컬럼이 드라이빙 테이블
- order by의 순서대로 생성된 인덱스가 있어야함
- 드라이빙테이블에 대한 조건이 있다면, 그 조건이랑 order by는 같은 인덱스 써야함.

extra) 사실 이 경우, 인덱스 정렬을 위해 ORDER BY 안넣어도 됨. 그렇지만 옵티마이저에서 알아서 걸러주니까 넣자.

extra) 조인버퍼가 사용되면 순서가 흐트러질 수 있다.

Q. 조인에서 order by의 기준값이  인덱스 활용은 못하지만, 드라이빙 테이블에 있는 컬럼일 경우 어떻게 정렬될까?드라이빙 테리블만 검색해서 정렬을 수행하고, 그 결과를 가지고 조인한다.

토론) 스트리밍 방식을 쓰는 경우가 어떤게 있을까?

JDBC같은 경우에는 기본적으로 버퍼링처리를 기본적으로 한다고 한다.

클라이언트-서버 사이에 소켓으로 바로바로 쏴줘야 하는 경우…?

정리) 어떤 정렬 방식으로 처리되는지는 큰 성능 차이를 만든다. 가능하다면 인덱스를 사용한 정렬로 유도하고, 불가능할 경우 최소한 드라이빙테이블만 정렬해도 되는 수준으로 유도하는 것이 좋다. → 아니면 임시테이블 만들고 난리..

### 9.2.4 Group By 처리

Q. 인덱스를 사용할 수 없는 Group By + Order By 는 어떻게 처리될까?

내부적으로 Group By 컬럼으로 구성된 유니크 테이블을 가진 임시 테이블을 만들고, 중복 제거와 집합 함수 연산을 수행한다.

create temporary table

### 9.2.5 Distinct 처리

유니크 레코드만 가져오는 경우 select distinct와 group by 는 동일한 방식으로 처리된다.

집합 함수가 없는 select 쿼리에서 distinct 는 조회하는 모든 컬럼의 조합이 유니크한 것만 가져온다.

집합 함수에서 사용된 distinct는 그 집합 함수의 인자로 전달된 칼럼값이 유니크한 것들을 가져온다.

### 9.3.1 옵티마이저 스위치 옵션

Q. 네스티드 루프 조인이란?

Q. MRR 또는 BKA 가 무엇일까요?

Q. 조인 버퍼란 무엇일까요?

Q. 인덱스 머지의 종류 3가지와 특징