# 5. 트랜잭션

**Q. OO은 동시성을 제어하기 위한 기능, OO은 데이터의 정합성을 보장하기 위한 개념이다.**

잠금은 동시성을 제어하기 위한 기능, 트랜잭션은 데이터의 정합성을 보장하기 위한 개념이다.

트랜잭션 → 커밋 or 콜백

잠금 → 접근제어

### 5.1.2 트랜잭션 주의사항

Q. **파일전송, 외부 API콜 등의 외부에 의존한 작업을 트랜잭션에 포함하지 말아야 하는 이유는?**

해당 커넥션의 시간이 언제 끝날지 모르고, 그동안 트래잭션이 종료되지 않고 계속 남아있기 때문.

### 5.2.1 글로벌락(백업락)

**Q. 백업락의 용도와 어떤 부분을 잠금하는지?**

백업을 위한 용도, 스키마나 사용자 인증 관련 정보들

### 5.2.2 테이블락

레코드기반 잠금으로 인해 묵시적인 테이블 락은 더이상 없음!

스키마를 변경하는 경우에만 영향을 미침

### 5.2.3 네임드락

**Q. 네임드락의 용도?**

많은 레코드에 대해서 복잡한 조건으로 레코드를 변경하는 경우. → 배치

동일 데이터를 변경하거나 참조하는 프로그램끼리 락을 걸고 분류

### 5.2.4 메타데이터 락

**Q. 메타데이터락의 용도?**

데이터베이스 테이블이나 뷰 등의 객체의 이름이나 구조를 변경하는 경우.

오.. 서비스 테이블을 이름만 바꿔서 필요한 데이터베이스로 갈아끼우기도 하는군.

### 5.3.1 InnoDB 스토리지 엔진의 잠금

**Q. InnoDB는 레코드 자체가 아니라 인덱스의 레코드를 잠그는데, 인덱스가 하나도 없는 테이블은 어떻게 하는지?**

내부적으로 자동 생성된 클러스터 인덱스를 이용하여 잠금

보조 인덱스를 걸어서 잠그는 방식은 넥스트 키락 또는 갭락을 사용한다.

PK나 유니크 이넥스는 레코드 자체에 락을 건다.

**넥스트 키 락**

갭락과 넥스트키락은 바이너리 로그에 기록되는 레플리카 서버에서 실행될 때 소스 서버에서 만들어 낸 결과와 동일한 결과를 만들게 유도.

→ 레플리카 DB 동기화 시 바이너리 로그를 통해 동기화.

근데 작동 방식이…?

- 레코드 락과 갭 락을 합쳐놓은 형태다. 인덱스 레코드도 잠그고 그 인덱스 레코드 앞, 뒤 갭도 잠근다.
- `SELECT c1 FROM t WHERE c1 BETWEEN 10 AND 20 FOR UPDATE;` 일 때, c1=15 인 레코드를 insert 하는 트랜잭션이 있다면 막는다. 반드시 인덱스 레코드 사이에 있는 갭만 락을 거는 게 아니라 제일 앞 또는 뒤에 있는 인덱스 레코드의 갭도 락을 건다. 예를 들어 c1=10인 레코드 인덱스 바로 앞에 c1=8인 레코드 인덱스가 있는 상태라면, c1=9인 레코드를 insert 하려고 하면 막힌다. (그 갭에도 락이 걸려있기 때문에!)

출처: [https://jeong-pro.tistory.com/241](https://jeong-pro.tistory.com/241)

자동증가락

auto_increament 잠금  최소화를 위해 이전의 pk를 재활용 하지 않음.

### 5.3.2 인덱스와 잠금

업데이트 쿼리에 조건이 두 가지가 있고,

조건1. 인덱스 걸려있음. 해당하는 값 300개

조건2. 인덱스 없음

→ 300개를 잠궈버린다.

만약 인덱스가 없다면?

→ 풀스캔 하면서 모든 레코드를 잠금

### 5.4.1

**READ UNCOMMITTED**

**Q. 발생 가능 문제**

처리한 작업이 완료되지 않았는데 다른 트랜잭션에서 볼 수 있음. → 더티리드

**READ COMMITED**

**Q. 발생 가능 문제**

커밋이 완료된 상태에서만 다른 트랜잭션에서 조회 가능. → 아니라면 언두 영역 접근

그러나 NON REPEATABLE READ 문제 발생. 조회를 한 번 하고, 다른 트랜잭션이 그 사이에 커밋되어 버리면 동일한 트랜잭션에서 조회 결과가 다를 수 있음.

**REPEATABLE READ**

**Q. InnoDB에서 말고 다른 DB에서의 발생 가능 문제**

해당 격리수준은 트랜잭션이 이전에 접근했던 언두 영역을 기억.

select for update 사용 중에 insert 가 발생해서 앞뒤 결과가 다름 → 팬텀리드

> update가 아니라 insert라서 언두 영역이 생기지 않는걸까?
> 

**Q. InnoDB 해당 문제를 어떻게 방지할까요?**

넥스트 키락

**SERIALIZABLE**

읽기 잠금이 있음.

해당 격리수준이 아니라면 성능 저하는 크게 발생하지 않음